
<!DOCTYPE HTML>
<html lang="us-en" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Decryption · containerd 英文文档</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism-solarizedlight.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="installation.html" />
    
    
    <link rel="prev" href="crictl.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    
    
        
        <li>
            <a href="https://docs.khs1994.com" target="_blank" class="custom-link">Home</a>
        </li>
    
    

    
    <li class="divider"></li>
    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    Cri
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="architecture.html">
            
                <a href="architecture.html">
            
                    
                    Architecture
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="config.html">
            
                <a href="config.html">
            
                    
                    Config
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="crictl.html">
            
                <a href="crictl.html">
            
                    
                    Crictl
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2.4" data-path="decryption.html">
            
                <a href="decryption.html">
            
                    
                    Decryption
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="installation.html">
            
                <a href="installation.html">
            
                    
                    Installation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="registry.html">
            
                <a href="registry.html">
            
                    
                    Registry
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7" data-path="testing.html">
            
                <a href="testing.html">
            
                    
                    Testing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    Historical
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" >
            
                <span>
            
                    
                    Cri
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1.1" data-path="../historical/cri/proposal.html">
            
                <a href="../historical/cri/proposal.html">
            
                    
                    Proposal
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2" >
            
                <span>
            
                    
                    Design
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.1" data-path="../historical/design/architecture.html">
            
                <a href="../historical/design/architecture.html">
            
                    
                    Architecture
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.2" data-path="../historical/design/data-flow.html">
            
                <a href="../historical/design/data-flow.html">
            
                    
                    Data Flow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3" data-path="../historical/design/lifecycle.html">
            
                <a href="../historical/design/lifecycle.html">
            
                    
                    Lifecycle
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.4" data-path="../historical/design/mounts.html">
            
                <a href="../historical/design/mounts.html">
            
                    
                    Mounts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.5" data-path="../historical/design/snapshots.html">
            
                <a href="../historical/design/snapshots.html">
            
                    
                    Snapshots
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.3" >
            
                <span>
            
                    
                    Reports
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.3.1" data-path="../historical/reports/2017-01-13.html">
            
                <a href="../historical/reports/2017-01-13.html">
            
                    
                    2017 01 13
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.2" data-path="../historical/reports/2017-01-20.html">
            
                <a href="../historical/reports/2017-01-20.html">
            
                    
                    2017 01 20
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.3" data-path="../historical/reports/2017-01-27.html">
            
                <a href="../historical/reports/2017-01-27.html">
            
                    
                    2017 01 27
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.4" data-path="../historical/reports/2017-02-10.html">
            
                <a href="../historical/reports/2017-02-10.html">
            
                    
                    2017 02 10
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.5" data-path="../historical/reports/2017-02-24.html">
            
                <a href="../historical/reports/2017-02-24.html">
            
                    
                    2017 02 24
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.6" data-path="../historical/reports/2017-03-10.html">
            
                <a href="../historical/reports/2017-03-10.html">
            
                    
                    2017 03 10
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.7" data-path="../historical/reports/2017-03-17.html">
            
                <a href="../historical/reports/2017-03-17.html">
            
                    
                    2017 03 17
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.8" data-path="../historical/reports/2017-03-24.html">
            
                <a href="../historical/reports/2017-03-24.html">
            
                    
                    2017 03 24
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.9" data-path="../historical/reports/2017-04-28.html">
            
                <a href="../historical/reports/2017-04-28.html">
            
                    
                    2017 04 28
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.10" data-path="../historical/reports/2017-05-05.html">
            
                <a href="../historical/reports/2017-05-05.html">
            
                    
                    2017 05 05
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.11" data-path="../historical/reports/2017-05-19.html">
            
                <a href="../historical/reports/2017-05-19.html">
            
                    
                    2017 05 19
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.12" data-path="../historical/reports/2017-05-26.html">
            
                <a href="../historical/reports/2017-05-26.html">
            
                    
                    2017 05 26
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.13" data-path="../historical/reports/2017-06-09.html">
            
                <a href="../historical/reports/2017-06-09.html">
            
                    
                    2017 06 09
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.14" data-path="../historical/reports/2017-06-23.html">
            
                <a href="../historical/reports/2017-06-23.html">
            
                    
                    2017 06 23
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    Man
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../man/containerd-config.8.html">
            
                <a href="../man/containerd-config.8.html">
            
                    
                    containerd-config.8
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../man/containerd-config.toml.5.html">
            
                <a href="../man/containerd-config.toml.5.html">
            
                    
                    containerd-config.toml.5
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../snapshotters/">
            
                <a href="../snapshotters/">
            
                    
                    Snapshotters
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../snapshotters/devmapper.html">
            
                <a href="../snapshotters/devmapper.html">
            
                    
                    Devmapper
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../client-opts.html">
            
                <a href="../client-opts.html">
            
                    
                    Client Opts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../content-flow.html">
            
                <a href="../content-flow.html">
            
                    
                    Content Flow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../garbage-collection.html">
            
                <a href="../garbage-collection.html">
            
                    
                    Garbage Collection
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../getting-started.html">
            
                <a href="../getting-started.html">
            
                    
                    Getting Started
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="../hosts.html">
            
                <a href="../hosts.html">
            
                    
                    Hosts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="../managed-opt.html">
            
                <a href="../managed-opt.html">
            
                    
                    Managed Opt
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="../namespaces.html">
            
                <a href="../namespaces.html">
            
                    
                    Namespaces
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="../NRI.html">
            
                <a href="../NRI.html">
            
                    
                    NRI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="../ops.html">
            
                <a href="../ops.html">
            
                    
                    Ops
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="../PLUGINS.html">
            
                <a href="../PLUGINS.html">
            
                    
                    PLUGINS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="../remote-snapshotter.html">
            
                <a href="../remote-snapshotter.html">
            
                    
                    Remote Snapshotter
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17" data-path="../rootless.html">
            
                <a href="../rootless.html">
            
                    
                    Rootless
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.18" data-path="../RUNC.html">
            
                <a href="../RUNC.html">
            
                    
                    RUNC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.19" data-path="../stream_processors.html">
            
                <a href="../stream_processors.html">
            
                    
                    Stream Processors
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.20" data-path="../tracing.html">
            
                <a href="../tracing.html">
            
                    
                    Tracing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.21" data-path="../transfer.html">
            
                <a href="../transfer.html">
            
                    
                    Transfer
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Decryption</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="configure-image-decryption">Configure Image Decryption</h1>
<p>This document describes the method to configure encrypted container image decryption for <code>containerd</code> for use with the <code>cri</code> plugin.</p>
<h2 id="encrypted-container-images">Encrypted Container Images</h2>
<p>Encrypted container images are OCI images which contain encrypted blobs. These encrypted images can be created through the use of <a href="https://github.com/containerd/imgcrypt" target="_blank">containerd/imgcrypt project</a>. To decrypt these images, the <code>containerd</code> runtime uses information passed from the <code>cri</code> such as keys, options and encryption metadata.</p>
<h2 id="the-node-key-model">The &quot;node&quot; Key Model</h2>
<p>Encryption ties trust to an entity based on the model in which a key is associated with it. We call this the key model. One such usecase is when we want to tie the trust of a key to the node in a cluster. In this case, we call it the &quot;node&quot; or &quot;host&quot; Key Model. Future work will include more key models to facilitate other trust associations (i.e. for multi-tenancy).</p>
<h3 id="node-key-model-usecase">&quot;node&quot; Key Model Usecase</h3>
<p>In this model encryption is tied to worker nodes. The usecase here revolves around the idea that an image should be decryptable only on trusted host. Using this model, various node based technologies which help bootstrap trust in worker nodes and perform secure key distribution (i.e. TPM, host attestation, secure/measured boot). In this scenario, runtimes are capable of fetching the necessary decryption keys. An example of this is using the <a href="https://github.com/containerd/imgcrypt" target="_blank"><code>--decryption-keys-path</code> flag in imgcrypt</a>.</p>
<h3 id="configuring-image-decryption-for-node-key-model">Configuring image decryption for &quot;node&quot; key model</h3>
<p>This is the default model since containerd v1.5.</p>
<p>For containerd v1.4, you need to add the following configuration to <code>/etc/containerd/config.toml</code> and restart the <code>containerd</code> service manually.</p>
<pre class="language-"><code class="lang-toml"><span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token number">2</span>

<span class="token punctuation">[</span><span class="token table class-name">plugins.&quot;io.containerd.grpc.v1.cri&quot;.image_decryption</span><span class="token punctuation">]</span>
  <span class="token key property">key_model</span> <span class="token punctuation">=</span> <span class="token string">&quot;node&quot;</span>

<span class="token punctuation">[</span><span class="token table class-name">stream_processors</span><span class="token punctuation">]</span>
  <span class="token punctuation">[</span><span class="token table class-name">stream_processors.&quot;io.containerd.ocicrypt.decoder.v1.tar.gzip&quot;</span><span class="token punctuation">]</span>
    <span class="token key property">accepts</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;application/vnd.oci.image.layer.v1.tar+gzip+encrypted&quot;</span><span class="token punctuation">]</span>
    <span class="token key property">returns</span> <span class="token punctuation">=</span> <span class="token string">&quot;application/vnd.oci.image.layer.v1.tar+gzip&quot;</span>
    <span class="token key property">path</span> <span class="token punctuation">=</span> <span class="token string">&quot;ctd-decoder&quot;</span>
    <span class="token key property">args</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;--decryption-keys-path&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/etc/containerd/ocicrypt/keys&quot;</span><span class="token punctuation">]</span>
    <span class="token key property">env</span><span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;OCICRYPT_KEYPROVIDER_CONFIG=/etc/containerd/ocicrypt/ocicrypt_keyprovider.conf&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">[</span><span class="token table class-name">stream_processors.&quot;io.containerd.ocicrypt.decoder.v1.tar&quot;</span><span class="token punctuation">]</span>
    <span class="token key property">accepts</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;application/vnd.oci.image.layer.v1.tar+encrypted&quot;</span><span class="token punctuation">]</span>
    <span class="token key property">returns</span> <span class="token punctuation">=</span> <span class="token string">&quot;application/vnd.oci.image.layer.v1.tar&quot;</span>
    <span class="token key property">path</span> <span class="token punctuation">=</span> <span class="token string">&quot;ctd-decoder&quot;</span>
    <span class="token key property">args</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;--decryption-keys-path&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/etc/containerd/ocicrypt/keys&quot;</span><span class="token punctuation">]</span>
    <span class="token key property">env</span><span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;OCICRYPT_KEYPROVIDER_CONFIG=/etc/containerd/ocicrypt/ocicrypt_keyprovider.conf&quot;</span><span class="token punctuation">]</span>
</code></pre>
<p>In this example, container image decryption is set to use the &quot;node&quot; key model.
In addition, the decryption <a href="https://github.com/containerd/containerd/blob/main/docs/stream_processors.md" target="_blank"><code>stream_processors</code></a> are configured as specified in <a href="https://github.com/containerd/imgcrypt" target="_blank">containerd/imgcrypt project</a>, with the additional field <code>--decryption-keys-path</code> configured to specify where decryption keys are located locally in the node.</p>
<p>The <code>$OCICRYPT_KEYPROVIDER_CONFIG</code> environment variable is used for <a href="https://github.com/containers/ocicrypt/blob/main/docs/keyprovider.md" target="_blank">ocicrypt keyprovider protocol</a>.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="crictl.html" class="navigation navigation-prev " aria-label="Previous page: Crictl">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="installation.html" class="navigation navigation-next " aria-label="Next page: Installation">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Decryption","level":"1.2.4","depth":2,"next":{"title":"Installation","level":"1.2.5","depth":2,"path":"cri/installation.md","ref":"cri/installation.md","articles":[]},"previous":{"title":"Crictl","level":"1.2.3","depth":2,"path":"cri/crictl.md","ref":"cri/crictl.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-sharing","-highlight","-livereload","prism"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"prism":{"css":["prismjs/themes/prism-solarizedlight.css"]},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"containerd 英文文档","language":"us-en","links":{"sidebar":{"Home":"https://docs.khs1994.com"}},"gitbook":"*"},"file":{"path":"cri/decryption.md","mtime":"2023-06-01T01:15:50.000Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2023-06-01T01:16:21.911Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

